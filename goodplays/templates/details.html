{% extends "base.html" %}
{% block content %}

<script type="text/javascript">
    function editPlay(id) {
    }

    function deletePlay(id) {
        if (!window.confirm('Delete this record?')) {
            return false;
        }

        window.location.href = `{{ url_for('delete_play') }}?id=${id}`
    }

    $(document).ready(() => {
        const inputs = $("tr#new-play input");
        const dates = $(".started input,.finished input");
        const started = $("tr#new-play .started input");
        const finished = $("tr#new-play .finished input");
        const status = $("tr#new-play .status select");

        // Enable JQuery UI's date picker.
        dates.datepicker({dateFormat: "yy-mm-dd"});

        // Submit on enter, reset on escape
        inputs.keydown((e) => {
            if (e.keyCode == 13) {
                $('#add_form').submit();
            }
            else if (e.keyCode == 27) {
                $('#add_form')[0].reset();
            }
        });

        // When started is set, automatically set status to "Playing"
        started.change((e) => {
            if (started.val() && status.val() === "interested") {
                status.val("playing");
            }
        });

        // When finished is set, automatically set status to "Completed"
        finished.change((e) => {
            if (finished.val() && status.val() !== "hundred") {
                status.val("completed");
            }
        });
    })
</script>

<div class="tabs">
    <h1>
        <ul>
            <li><a href={{ url_for('games') }}>Games</a></li>
            <li><a href={{ url_for('plays') }}>Plays</a></li>
            <li class="selected"><a href={{ url_for('details', id=game.id) }}>{{ game.name }}</a></li>
            <li>&nbsp;</li>
        </ul>
    </h1>
</div>

<div id="game">
    <img class="art" src="{{ game.image_url if game.image_url else url_for('static', filename='default.png') }}" />
    <p class="info">
        <span>{{ game.description }}</span>
    </p>
    <p class="info">
        <span class="label">Released:</span>
        <span>{{ game.released if game.released else "Unknown" }}</span>
    </p>
    <p class="info">
        <span class="label">Platforms:</span>
        <span>{{ game.platforms | map(attribute="name") | join(", ") }}</span>
    </p>
    {% if game.rating %}
    <p class="info">
        <span class="label">Rating:</span>
        <span>{{ game.stars }}</span>
    </p>
    {% endif %}
    {% if game.gb_id %}
    <p class="info">
        <span><a class="button" href="{{ url_for('update', id=game.id) }}">Update Details</a></span>
        <span><a class="button" href="{{ game.gb_url }}">View on Giant Bomb</a></span>
    </p>
    {% endif %}
</div>

{% if user and user.is_authenticated %}
<form id="add_form" action="{{ url_for('add_play', game_id=game.id) }}" method="POST" autocomplete="off">{{ add_form.hidden_tag() }}</form>
<form id="edit_form" action="{{ url_for('edit_play') }}" method="POST" autocomplete="off">{{ edit_form.hidden_tag() }}</form>

<table id="plays">
    <thead>
        <tr>
            <th class="started">Started</th>
            <th class="finished">Finished</th>
            <th class="status">Status</th>
            <th class="tags">Tags</th>
            <th class="comments">Comments</th>
            <th class="rating">Rating</th>
            <th class="icon"></th>
            <th class="icon"></th>
        </tr>
    </thead>
    <tbody>
        <tr id="new-play">
            <td class="started">{{ add_form.started(form="add_form") }}</td>
            <td class="finished">{{ add_form.finished(form="add_form") }}</td>
            <td class="status">{{ add_form.status(form="add_form") }}</td>
            <td class="tags">{{ add_form.tags(form="add_form") }}</td>
            <td class="comments">{{ add_form.comments(form="add_form") }}</td>
            <td class="rating">{{ add_form.rating(form="add_form")}}</td>
            <td class="icon"><a id="submit_add" href="#" onclick="$('#add_form').submit()"><img class="icon" src="{{url_for('static', filename='save.png')}}" title="Save" /></a></td>
            <td class="icon"><a id="clear_add" href="#" onclick="$('#add_form')[0].reset()"><img class="icon" src="{{url_for('static', filename='delete.png')}}" title="Clear" /></a></td>
        </tr>
        {% if plays %}
        {% for play in plays %}
        <tr id="{{ play.id }}">
            <td class="started">{{ play.started if play.started else "" }}</td>
            <td class="finished">{{ play.finished if play.finished else "" }}</td>
            <td class="status">{{ play.status.pretty() }}</td>
            <td class="tags">{{ play.tags | map(attribute='name') | join(", ") }}</td>
            <td class="comments">{{ play.comments }}</td>
            <td class="rating">{{ play.stars }}</td>
            <td class="icon"><a id="edit_{{ play.id }}" href="#" onclick="editPlay({{ play.id }})"><img class="icon" src="{{url_for('static', filename='edit.png')}}" title="Edit" /></a></td>
            <td class="icon"><a id="delete_{{ play.id }}" href="#" onclick="deletePlay({{ play.id }})"><img class="icon" src="{{url_for('static', filename='delete.png')}}" title="Delete" /></a></td>
        </tr>
        {% endfor %}
        {% endif %}
    </tbody>
</table>
{% endif %}

{% if game.gb_id %}
<div class="footer">
    <object class="gb-logo" type="image/svg+xml" data="{{ url_for('static', filename='gb.svg')}}">Giant Bomb Logo</object>
    <span>Some content on this page provided by <a href="https://www.giantbomb.com/">Giant Bomb</a> via their excellent <a href="https://www.giantbomb.com/api/">API</a>. Thanks!</span>
</div>
{% endif %}

{% endblock %}
